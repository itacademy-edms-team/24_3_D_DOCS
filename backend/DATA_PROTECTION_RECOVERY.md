# Data Protection: восстановление при потере key ring

## Контекст

ASP.NET Core Data Protection хранит ключи шифрования (key ring) в PostgreSQL через `PersistKeysToDbContext`. Эти ключи используются для шифрования пользовательских API ключей Ollama в таблице `user_ollama_api_keys`.

## При потере key ring

Если ключи Data Protection будут утеряны (удаление БД, потеря бэкапа, сброс миграций и т.п.):

1. **Все зашифрованные API ключи** в `user_ollama_api_keys` станут **нечитаемыми**.
2. Расшифровка вернёт ошибку `CryptographicException`.
3. Метод `GetDecryptedApiKeyAsync` вернёт `null` для таких записей.

## Восстановление

**Единственный способ:** пользователи должны заново настроить свои Ollama API ключи через API:

- `POST /api/ai/ollama-key` с телом `{ "apiKey": "..." }`

Существующие записи в `user_ollama_api_keys` с повреждённым ciphertext можно удалить вручную или оставить (они не будут использоваться).

## Рекомендации

- **Регулярные защищённые бэкапы БД** критичны.
- БД должна быть доступна только приложению и защищена на уровне инфраструктуры.
- При миграции на новый сервер — копировать БД целиком, включая таблицы `DataProtectionKeys` и `__EFMigrationsHistory`.
